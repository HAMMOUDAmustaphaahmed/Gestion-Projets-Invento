{% extends "base.html" %}

{% block title %}Gestion du stock - {{ app_name }}{% endblock %}

{% block page_title %}
<i class="bi bi-box-seam"></i> Gestion du stock
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{{ url_for('stock.add') }}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nouvel élément
    </a>
    <a href="{{ url_for('stock.alerts') }}" class="btn btn-outline-warning position-relative ms-2">
        <i class="bi bi-exclamation-triangle"></i> Alertes
        {% if stock_alerts_count > 0 %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ stock_alerts_count }}
        </span>
        {% endif %}
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Filtres -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Recherche</label>
                <input type="text" class="form-control" name="search" value="{{ search }}" 
                       placeholder="Référence ou libellé...">
            </div>
            <div class="col-md-3">
                <label class="form-label">Catégorie</label>
                <select class="form-select" name="category">
                    <option value="0">Toutes les catégories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Fournisseur</label>
                <select class="form-select" name="supplier">
                    <option value="0">Tous les fournisseurs</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" {% if selected_supplier == supplier.id %}selected{% endif %}>
                        {{ supplier.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-filter"></i> Filtrer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tableau du stock -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Inventaire</h5>
        <div>
            <small class="text-muted">{{ items.total }} élément(s)</small>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Référence</th>
                        <th>Libellé</th>
                        <th>Catégorie</th>
                        <th>Quantité</th>
                        <th>Stock min.</th>
                        <th>Prix unitaire</th>
                        <th>Valeur totale</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items.items %}
                    <tr class="{% if item.check_alert() %}table-warning{% endif %}">
                        <td>
                            <strong>{{ item.reference }}</strong>
                        </td>
                        <td>{{ item.libelle }}</td>
                        <td>
                            {% if item.category %}
                            <span class="badge bg-secondary">{{ item.category.name }}</span>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <span class="fw-bold">{{ item.quantity }}</span>
                        </td>
                        <td>{{ item.min_quantity }}</td>
                        <td>{{ item.price|format_currency }}</td>
                        <td>
                            <strong>{{ item.value|format_currency }}</strong>
                        </td>
                        <td>
                            {% if item.check_alert() %}
                            <span class="badge bg-danger">Stock bas</span>
                            {% elif item.quantity == 0 %}
                            <span class="badge bg-secondary">Rupture</span>
                            {% else %}
                            <span class="badge bg-success">Disponible</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('stock.view', item_id=item.id) }}" 
                                   class="btn btn-outline-primary" title="Voir">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="{{ url_for('stock.edit', item_id=item.id) }}" 
                                   class="btn btn-outline-secondary" title="Modifier">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button class="btn btn-outline-danger" 
                                        onclick="deleteItem({{ item.id }}, '{{ item.reference }}')"
                                        title="Supprimer">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if items.pages > 1 %}
        <nav aria-label="Pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                {% if items.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('stock.index', page=items.prev_num, search=search, category=selected_category, supplier=selected_supplier) }}">
                        &laquo; Précédent
                    </a>
                </li>
                {% endif %}
                
                {% for page_num in items.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == items.page %}active{% endif %}">
                            <a class="page-link" href="{{ url_for('stock.index', page=page_num, search=search, category=selected_category, supplier=selected_supplier) }}">
                                {{ page_num }}
                            </a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    {% endif %}
                {% endfor %}
                
                {% if items.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('stock.index', page=items.next_num, search=search, category=selected_category, supplier=selected_supplier) }}">
                        Suivant &raquo;
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
    <div class="card-footer">
        <div class="row">
            <div class="col-md-6">
                <small class="text-muted">
                    Valeur totale du stock: <strong>{{ total_stock_value|format_currency }}</strong>
                </small>
            </div>
            <div class="col-md-6 text-end">
                <div class="btn-group">
                    <a href="{{ url_for('stock.suppliers') }}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-truck"></i> Fournisseurs
                    </a>
                    <a href="{{ url_for('stock.categories') }}" class="btn btn-outline-secondary btn-sm ms-2">
                        <i class="bi bi-tags"></i> Catégories
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation de suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmMessage">
                <!-- Message de confirmation -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmAction">Supprimer</button>
            </div>
        </div>
    </div>
</div>

<script>
function deleteItem(itemId, reference) {
    $('#confirmMessage').html(`
        <p>Êtes-vous sûr de vouloir supprimer l'élément <strong>${reference}</strong> ?</p>
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i> Cette action est irréversible. 
            Tous les fichiers associés seront également supprimés.
        </div>
    `);
    
    $('#confirmAction').off('click').on('click', function() {
        $.ajax({
            url: `/stock/delete/${itemId}`,
            type: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert(response.message || 'Erreur lors de la suppression');
                }
            },
            error: function() {
                alert('Erreur réseau');
            }
        });
        $('#confirmModal').modal('hide');
    });
    
    $('#confirmModal').modal('show');
}
</script>

<style>
.table-warning {
    background-color: rgba(255, 193, 7, 0.1);
}
</style>
{% endblock %}