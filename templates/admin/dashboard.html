{% extends "base.html" %}

{% block title %}Administration - {{ app_name }}{% endblock %}

{% block page_title %}
<i class="bi bi-speedometer2"></i> Tableau de bord Administrateur
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{{ url_for('admin.users') }}" class="btn btn-outline-primary">
        <i class="bi bi-people"></i> Gérer les utilisateurs
    </a>
    <a href="{{ url_for('admin.roles') }}" class="btn btn-outline-secondary ms-2">
        <i class="bi bi-shield-check"></i> Gérer les rôles
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Statistiques -->
    <div class="col-md-3 mb-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Utilisateurs</h6>
                        <h2 class="mb-0">{{ stats.total_users }}</h2>
                    </div>
                    <i class="bi bi-people fs-1"></i>
                </div>
                <div class="mt-2">
                    <small>{{ stats.active_users }} actifs</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Rôles</h6>
                        <h2 class="mb-0">{{ stats.total_roles }}</h2>
                    </div>
                    <i class="bi bi-shield-check fs-1"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Notifications</h6>
                        <h2 class="mb-0">{{ stats.unread_notifications }}</h2>
                    </div>
                    <i class="bi bi-bell fs-1"></i>
                </div>
                <div class="mt-2">
                    <small>non lues</small>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-3 mb-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="card-title mb-0">Sessions actives</h6>
                        <h2 class="mb-0">{{ stats.active_sessions|default(0) }}</h2>
                    </div>
                    <i class="bi bi-person-check fs-1"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Utilisateurs récents -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Utilisateurs récents</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for user in recent_users %}
                    <div class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ user.get_full_name() }}</h6>
                                <small class="text-muted">{{ user.username }}</small>
                            </div>
                            <div>
                                <span class="badge bg-{{ 'success' if user.is_active else 'secondary' }}">
                                    {{ 'Actif' if user.is_active else 'Inactif' }}
                                </span>
                                <small class="text-muted d-block">{{ user.created_at|format_date }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="mt-3 text-center">
                    <a href="{{ url_for('admin.users') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-list"></i> Voir tous les utilisateurs
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Activités système -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Activités système</h5>
            </div>
            <div class="card-body">
                <div id="systemActivities">
                    <!-- Les activités seront chargées via AJAX -->
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Statistiques d'utilisation -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Statistiques d'utilisation</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <div class="p-3 border rounded">
                            <div class="text-primary fs-2" id="stockCount">0</div>
                            <div class="text-muted">Articles en stock</div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="p-3 border rounded">
                            <div class="text-success fs-2" id="projectCount">0</div>
                            <div class="text-muted">Projets actifs</div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="p-3 border rounded">
                            <div class="text-warning fs-2" id="taskCount">0</div>
                            <div class="text-muted">Tâches en cours</div>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="p-3 border rounded">
                            <div class="text-info fs-2" id="personnelCount">0</div>
                            <div class="text-muted">Personnel actif</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Logs système -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Logs système récents</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="systemLogs">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Utilisateur</th>
                                <th>Action</th>
                                <th>Détails</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Les logs seront chargés via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Charger les activités système
    loadSystemActivities();
    
    // Charger les statistiques
    loadAdminStats();
    
    // Charger les logs
    loadSystemLogs();
});

function loadSystemActivities() {
    $.ajax({
        url: '/api/admin/activities',
        type: 'GET',
        success: function(data) {
            let html = '';
            if (data.activities && data.activities.length > 0) {
                data.activities.forEach(function(activity) {
                    html += `
                    <div class="d-flex mb-3">
                        <div class="flex-shrink-0">
                            <i class="bi bi-${activity.icon} text-${activity.color} fs-4"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-0">${activity.title}</h6>
                            <p class="mb-0 text-muted">${activity.description}</p>
                            <small class="text-muted">${activity.time}</small>
                        </div>
                    </div>
                    `;
                });
            } else {
                html = '<p class="text-muted text-center">Aucune activité récente</p>';
            }
            $('#systemActivities').html(html);
        }
    });
}

function loadAdminStats() {
    $.ajax({
        url: '/api/admin/stats',
        type: 'GET',
        success: function(data) {
            if (data.stock_count) $('#stockCount').text(data.stock_count);
            if (data.project_count) $('#projectCount').text(data.project_count);
            if (data.task_count) $('#taskCount').text(data.task_count);
            if (data.personnel_count) $('#personnelCount').text(data.personnel_count);
        }
    });
}

function loadSystemLogs() {
    $.ajax({
        url: '/api/admin/logs',
        type: 'GET',
        success: function(data) {
            let html = '';
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(function(log) {
                    let badgeClass = 'secondary';
                    if (log.type === 'error') badgeClass = 'danger';
                    else if (log.type === 'warning') badgeClass = 'warning';
                    else if (log.type === 'info') badgeClass = 'info';
                    else if (log.type === 'success') badgeClass = 'success';
                    
                    html += `
                    <tr>
                        <td>${log.date}</td>
                        <td><span class="badge bg-${badgeClass}">${log.type}</span></td>
                        <td>${log.user || 'Système'}</td>
                        <td>${log.action}</td>
                        <td><small class="text-muted">${log.details || ''}</small></td>
                    </tr>
                    `;
                });
            } else {
                html = '<tr><td colspan="5" class="text-center">Aucun log disponible</td></tr>';
            }
            $('#systemLogs tbody').html(html);
        }
    });
}

function refreshLogs() {
    loadSystemLogs();
}
</script>
{% endblock %}