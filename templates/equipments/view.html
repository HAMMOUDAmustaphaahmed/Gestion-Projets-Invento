{% extends "base.html" %}

{% block title %}{{ title }} - {{ app_name }}{% endblock %}

{% block page_title %}
<i class="bi bi-pc-display"></i> Équipement : {{ equipment.reference }}
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <a href="{{ url_for('equipments.edit', equipment_id=equipment.id) }}" 
       class="btn btn-outline-secondary">
        <i class="bi bi-pencil"></i> Modifier
    </a>
    <a href="{{ url_for('equipments.upload_file', equipment_id=equipment.id) }}" 
       class="btn btn-outline-primary">
        <i class="bi bi-upload"></i> Uploader
    </a>
    <a href="{{ url_for('equipments.add_maintenance', equipment_id=equipment.id) }}" 
       class="btn btn-outline-warning">
        <i class="bi bi-tools"></i> Maintenance
    </a>
    <a href="{{ url_for('equipments.add_stock_item', equipment_id=equipment.id) }}" 
       class="btn btn-outline-info">
        <i class="bi bi-box-seam"></i> Ajouter stock
    </a>
    <button type="button" class="btn btn-outline-danger" 
            onclick="confirmDelete({{ equipment.id }}, '{{ equipment.reference }}')">
        <i class="bi bi-trash"></i> Supprimer
    </button>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Informations principales -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Informations générales</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th width="40%">Référence</th>
                                <td>{{ equipment.reference }}</td>
                            </tr>
                            <tr>
                                <th>Nom</th>
                                <td>{{ equipment.name }}</td>
                            </tr>
                            <tr>
                                <th>Catégorie</th>
                                <td>
                                    {% if equipment.category %}
                                    <span class="badge bg-secondary">{{ equipment.category.name }}</span>
                                    {% else %}
                                    <span class="text-muted">Non définie</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Statut</th>
                                <td>
                                    {% if equipment.status == 'available' %}
                                        <span class="badge bg-success">Disponible</span>
                                    {% elif equipment.status == 'in_use' %}
                                        <span class="badge bg-primary">En utilisation</span>
                                    {% elif equipment.status == 'maintenance' %}
                                        <span class="badge bg-warning">En maintenance</span>
                                    {% elif equipment.status == 'out_of_service' %}
                                        <span class="badge bg-danger">Hors service</span>
                                    {% elif equipment.status == 'reserved' %}
                                        <span class="badge bg-info">Réservé</span>
                                    {% elif equipment.status == 'disposed' %}
                                        <span class="badge bg-secondary">Mis au rebut</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Localisation</th>
                                <td>{{ equipment.location or '-' }}</td>
                            </tr>
                            <tr>
                                <th>Département</th>
                                <td>{{ equipment.department or '-' }}</td>
                            </tr>
                            <tr>
                                <th>Responsable</th>
                                <td>{{ equipment.responsible_person or '-' }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <th width="40%">Numéro de série</th>
                                <td>{{ equipment.serial_number or '-' }}</td>
                            </tr>
                            <tr>
                                <th>Modèle</th>
                                <td>{{ equipment.model or '-' }}</td>
                            </tr>
                            <tr>
                                <th>Marque</th>
                                <td>{{ equipment.brand or '-' }}</td>
                            </tr>
                            <tr>
                                <th>Fournisseur</th>
                                <td>
                                    {% if equipment.supplier %}
                                    {{ equipment.supplier.name }}
                                    {% else %}
                                    <span class="text-muted">Non défini</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Date d'achat</th>
                                <td>{{ equipment.purchase_date|format_date if equipment.purchase_date else '-' }}</td>
                            </tr>
                            <tr>
                                <th>Garantie jusqu'au</th>
                                <td>
                                    {% if equipment.warranty_until %}
                                        {% if equipment.warranty_until > today %}
                                            <span class="text-success">{{ equipment.warranty_until|format_date }}</span>
                                        {% else %}
                                            <span class="text-danger">{{ equipment.warranty_until|format_date }}</span>
                                        {% endif %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Description et notes -->
                {% if equipment.description or equipment.notes %}
                <div class="row mt-3">
                    {% if equipment.description %}
                    <div class="col-md-6">
                        <h6>Description</h6>
                        <div class="border rounded p-3 bg-light">
                            {{ equipment.description|nl2br }}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if equipment.notes %}
                    <div class="col-md-6">
                        <h6>Notes</h6>
                        <div class="border rounded p-3 bg-light">
                            {{ equipment.notes|nl2br }}
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Éléments de stock associés -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Éléments de stock associés</h5>
                <span class="badge bg-light text-dark">{{ stock_items|length }}</span>
            </div>
            <div class="card-body">
                {% if stock_items %}
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Référence</th>
                                <th>Libellé</th>
                                <th>Quantité utilisée</th>
                                <th>Prix unitaire</th>
                                <th>Valeur</th>
                                <th>Notes</th>
                                <th>Ajouté le</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock_item, quantity_used, notes, added_at in stock_items %}
                            <tr>
                                <td>{{ stock_item.reference }}</td>
                                <td>{{ stock_item.libelle }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ quantity_used }} {{ stock_item.unit }}</span>
                                </td>
                                <td>{{ stock_item.price|format_currency }}</td>
                                <td>{{ (stock_item.price * quantity_used)|format_currency }}</td>
                                <td>
                                    {% if notes %}
                                    <small class="text-muted">{{ notes|truncate(30) }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ added_at|format_datetime }}</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a href="{{ url_for('stock.view', item_id=stock_item.id) }}" 
                                           class="btn btn-outline-secondary" title="Voir">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <button class="btn btn-outline-warning" 
                                                onclick="updateQuantity({{ stock_item.id }}, {{ quantity_used }})"
                                                title="Modifier quantité">
                                            <i class="bi bi-pencil-square"></i>
                                        </button>
                                        <button class="btn btn-outline-danger" 
                                                onclick="removeStockItem({{ stock_item.id }}, '{{ stock_item.reference }}')"
                                                title="Retirer">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-secondary">
                                <td colspan="4" class="text-end"><strong>Valeur totale des éléments :</strong></td>
                                <td colspan="4"><strong>{{ equipment.get_attached_stock_value()|format_currency }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-box-seam text-muted" style="font-size: 3rem;"></i>
                    <p class="text-muted mt-3">Aucun élément de stock associé</p>
                    <a href="{{ url_for('equipments.add_stock_item', equipment_id=equipment.id) }}" 
                       class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> Ajouter un élément
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Historique de maintenance -->
        <div class="card">
            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Historique de maintenance</h5>
                <a href="{{ url_for('equipments.add_maintenance', equipment_id=equipment.id) }}" 
                   class="btn btn-sm btn-light">
                    <i class="bi bi-plus"></i> Nouvelle
                </a>
            </div>
            <div class="card-body">
                {% if equipment.maintenance_logs.count() > 0 %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Effectué par</th>
                                <th>Coût</th>
                                <th>Description</th>
                                <th>Prochaine</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for maintenance in maintenances %}
                            <tr>
                                <td>{{ maintenance.maintenance_date|format_date }}</td>
                                <td>
                                    <span class="badge 
                                        {% if maintenance.maintenance_type == 'preventive' %}bg-info
                                        {% elif maintenance.maintenance_type == 'corrective' %}bg-warning
                                        {% elif maintenance.maintenance_type == 'calibration' %}bg-success
                                        {% else %}bg-secondary{% endif %}">
                                        {{ maintenance.maintenance_type|replace('_', ' ')|title }}
                                    </span>
                                </td>
                                <td>{{ maintenance.performed_by or '-' }}</td>
                                <td>
                                    {% if maintenance.cost %}
                                    {{ maintenance.cost|format_currency }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ maintenance.description|truncate(50) }}</small>
                                </td>
                                <td>
                                    {% if maintenance.next_maintenance_date %}
                                    {{ maintenance.next_maintenance_date|format_date }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" 
                                            onclick="viewMaintenance({{ maintenance.id }})">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-tools text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">Aucune maintenance enregistrée</p>
                </div>
                {% endif %}
                
                <!-- Dates de maintenance importantes -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><i class="bi bi-calendar-check"></i> Dernière maintenance</h6>
                            <p class="mb-0">
                                {% if equipment.last_maintenance %}
                                <strong>{{ equipment.last_maintenance|format_date }}</strong>
                                {% else %}
                                <span class="text-muted">Jamais</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning">
                            <h6><i class="bi bi-calendar-event"></i> Prochaine maintenance</h6>
                            <p class="mb-0">
                                {% if equipment.next_maintenance %}
                                    {% if equipment.next_maintenance > today %}
                                        <strong class="text-success">{{ equipment.next_maintenance|format_date }}</strong>
                                    {% else %}
                                        <strong class="text-danger">{{ equipment.next_maintenance|format_date }}</strong>
                                        <small class="text-danger">(En retard)</small>
                                    {% endif %}
                                {% else %}
                                <span class="text-muted">Non planifiée</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar avec informations financières et fichiers -->
    <div class="col-md-4">
        <!-- Informations financières -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Informations financières</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Prix d'achat</th>
                        <td class="text-end">{{ equipment.purchase_price|format_currency }}</td>
                    </tr>
                    <tr>
                        <th>Valeur actuelle</th>
                        <td class="text-end">{{ equipment.current_value|format_currency }}</td>
                    </tr>
                    <tr>
                        <th>Valeur stock attaché</th>
                        <td class="text-end">{{ equipment.get_attached_stock_value()|format_currency }}</td>
                    </tr>
                    <tr class="table-primary">
                        <th><strong>Valeur totale</strong></th>
                        <td class="text-end"><strong>{{ total_value|format_currency }}</strong></td>
                    </tr>
                </table>
                
                <!-- Indicateur de dépréciation -->
                {% if equipment.purchase_price and equipment.current_value and equipment.purchase_date %}
                <div class="mt-3">
                    <small class="text-muted">Dépréciation</small>
                    {% set depreciation = ((equipment.purchase_price - equipment.current_value) / equipment.purchase_price * 100) %}
                    <div class="progress mt-1">
                        <div class="progress-bar 
                            {% if depreciation < 30 %}bg-success
                            {% elif depreciation < 60 %}bg-warning
                            {% else %}bg-danger{% endif %}" 
                            style="width: {{ depreciation|round }}%">
                            {{ depreciation|round }}%
                        </div>
                    </div>
                    <small class="text-muted">Depuis {{ equipment.purchase_date|format_date }}</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Fichiers attachés -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Fichiers</h5>
                <a href="{{ url_for('equipments.upload_file', equipment_id=equipment.id) }}" 
                   class="btn btn-sm btn-light">
                    <i class="bi bi-plus"></i> Ajouter
                </a>
            </div>
            <div class="card-body">
                {% if equipment.files.count() > 0 %}
                <div class="list-group list-group-flush">
                    {% for file in equipment.files.all() %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <i class="bi 
                                    {% if file.file_type in ['pdf'] %}bi-file-pdf text-danger
                                    {% elif file.file_type in ['jpg', 'jpeg', 'png', 'gif'] %}bi-file-image text-success
                                    {% elif file.file_type in ['doc', 'docx'] %}bi-file-word text-primary
                                    {% elif file.file_type in ['xls', 'xlsx'] %}bi-file-excel text-success
                                    {% else %}bi-file-text text-secondary{% endif %} me-2">
                                </i>
                                <a href="{{ url_for('equipments.download_file', file_id=file.id) }}"
                                   class="text-decoration-none">
                                    {{ file.original_filename|truncate(20) }}
                                </a>
                                {% if file.description %}
                                <br><small class="text-muted">{{ file.description }}</small>
                                {% endif %}
                            </div>
                            <div>
                                <small class="text-muted me-2">{{ file.file_type|upper }}</small>
                                <button class="btn btn-sm btn-outline-danger"
                                        onclick="deleteFile({{ file.id }}, '{{ file.original_filename }}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="bi bi-folder text-muted" style="font-size: 2rem;"></i>
                    <p class="text-muted mt-2">Aucun fichier attaché</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Métadonnées -->
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Métadonnées</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th>Créé le</th>
                        <td>{{ equipment.created_at|format_datetime }}</td>
                    </tr>
                    <tr>
                        <th>Mis à jour le</th>
                        <td>{{ equipment.updated_at|format_datetime }}</td>
                    </tr>
                    <tr>
                        <th>Actif</th>
                        <td>
                            {% if equipment.is_active %}
                            <i class="bi bi-check-circle text-success"></i> Oui
                            {% else %}
                            <i class="bi bi-x-circle text-danger"></i> Non
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
<div class="modal fade" id="updateQuantityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('equipments.update_stock_quantity', equipment_id=equipment.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="modalStockItemId" name="stock_item_id">
                
                <div class="modal-header">
                    <h5 class="modal-title">Modifier la quantité</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Élément : <strong id="modalStockItemName"></strong></p>
                    
                    <div class="mb-3">
                        <label for="quantity" class="form-label">Quantité utilisée</label>
                        <input type="number" class="form-control" id="quantity" name="quantity" 
                               step="0.01" min="0.01" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="maintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Détails de la maintenance</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="maintenanceContent">
                <!-- Contenu chargé dynamiquement -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
function confirmDelete(equipmentId, reference) {
    if (confirm(`Êtes-vous sûr de vouloir supprimer l'équipement "${reference}" ?\n\nCette action est irréversible.`)) {
        fetch(`/equipments/delete/${equipmentId}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        }).then(response => {
            if (response.ok) {
                window.location.href = '/equipments';
            } else {
                alert('Erreur lors de la suppression');
            }
        });
    }
}

function updateQuantity(stockItemId, currentQuantity) {
    document.getElementById('modalStockItemId').value = stockItemId;
    document.getElementById('quantity').value = currentQuantity;
    document.getElementById('modalStockItemName').textContent = document.querySelector(`tr td:first-child`).textContent.trim();
    
    const modal = new bootstrap.Modal(document.getElementById('updateQuantityModal'));
    modal.show();
}

function removeStockItem(stockItemId, reference) {
    if (confirm(`Retirer l'élément "${reference}" de cet équipement ?`)) {
        fetch(`/equipments/${equipment.id}/stock/${stockItemId}/remove`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors du retrait');
            }
        });
    }
}

function deleteFile(fileId, filename) {
    if (confirm(`Supprimer le fichier "${filename}" ?`)) {
        fetch(`/equipments/file/${fileId}/delete`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token() }}'
            }
        }).then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        });
    }
}

function viewMaintenance(maintenanceId) {
    fetch(`/api/equipment-maintenance/${maintenanceId}`)
        .then(response => response.json())
        .then(data => {
            const content = `
                <table class="table">
                    <tr>
                        <th width="30%">Date</th>
                        <td>${data.maintenance_date}</td>
                    </tr>
                    <tr>
                        <th>Type</th>
                        <td><span class="badge ${data.type_class}">${data.maintenance_type}</span></td>
                    </tr>
                    <tr>
                        <th>Effectué par</th>
                        <td>${data.performed_by || '-'}</td>
                    </tr>
                    <tr>
                        <th>Coût</th>
                        <td>${data.cost || '-'}</td>
                    </tr>
                    <tr>
                        <th>Prochaine maintenance</th>
                        <td>${data.next_maintenance_date || '-'}</td>
                    </tr>
                    <tr>
                        <th colspan="2">Description</th>
                    </tr>
                    <tr>
                        <td colspan="2">${data.description}</td>
                    </tr>
                    ${data.notes ? `
                    <tr>
                        <th colspan="2">Notes</th>
                    </tr>
                    <tr>
                        <td colspan="2">${data.notes}</td>
                    </tr>` : ''}
                </table>
            `;
            document.getElementById('maintenanceContent').innerHTML = content;
            new bootstrap.Modal(document.getElementById('maintenanceModal')).show();
        });
}
</script>
{% endblock %}