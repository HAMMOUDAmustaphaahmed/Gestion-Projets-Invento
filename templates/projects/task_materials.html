{% extends "base.html" %}

{% block title %}Gestion des mat√©riaux - T√¢che {{ task.name }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --editable-bg: #e3f2fd;
        --editable-border: #2196f3;
        --editable-focus: #1976d2;
        --editable-hover: #bbdefb;
        --success-bg: #c8e6c9;
        --error-bg: #ffcdd2;
        --saving-bg: #fff9c4;
    }

    .materials-table-container { position: relative; overflow-x: auto; }

    .cell-editable { position: relative; cursor: pointer; transition: all 0.2s ease; user-select: none; }
    .cell-value {
        display: inline-flex; align-items: center; justify-content: center;
        min-width: 80px; padding: 8px 16px; border-radius: 8px;
        background: var(--editable-bg); border: 2px solid transparent;
        font-weight: 600; color: #1565c0; transition: all 0.2s ease;
    }
    .cell-editable:hover .cell-value {
        background: var(--editable-hover); border-color: var(--editable-border);
        box-shadow: 0 4px 12px rgba(33,150,243,0.3);
    }
    .cell-value::after {
        content: '\f4ca'; font-family: 'bootstrap-icons'; font-size: 0.75rem;
        margin-left: 6px; opacity: 0; transition: opacity 0.2s;
    }
    .cell-editable:hover .cell-value::after { opacity: 0.6; }
    .cell-editable.editing .cell-value { display: none; }
    .cell-input {
        display: none; width: 100px; padding: 8px 12px;
        border: 2px solid var(--editable-focus); border-radius: 8px;
        text-align: center; font-size: 1rem; font-weight: 600;
        background: white; color: #1565c0;
        box-shadow: 0 4px 16px rgba(25,118,210,0.25);
    }
    .cell-editable.editing .cell-input { display: inline-block; }
    .cell-editable.saving { opacity: 0.7; pointer-events: none; }
    .cell-editable.saved .cell-value { background: var(--success-bg); color: #2e7d32; animation: savedPulse 0.6s ease; }
    .cell-editable.error .cell-value { background: var(--error-bg); color: #c62828; }
    @keyframes savedPulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.05)} }
    .cell-spinner {
        display: none; width: 16px; height: 16px;
        border: 2px solid #e3f2fd; border-top: 2px solid var(--editable-focus);
        border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 8px;
    }
    .cell-editable.saving .cell-spinner { display: inline-block; }
    @keyframes spin { 0%{transform:rotate(0deg)} 100%{transform:rotate(360deg)} }

    .action-btn {
        width: 32px; height: 32px; padding: 0;
        display: inline-flex; align-items: center; justify-content: center;
        border-radius: 6px; transition: all 0.2s;
        border: none; background: transparent; color: #6c757d;
    }
    .action-btn:hover { background: #e9ecef; transform: translateY(-1px); }
    .action-btn.edit-btn:hover  { background: #e3f2fd; color: #1976d2; }
    .action-btn.delete-btn:hover{ background: #ffebee; color: #c62828; }

    .toast-container {
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        display: flex; flex-direction: column; gap: 10px;
    }
    .toast-custom {
        padding: 14px 24px; border-radius: 10px; color: white; font-weight: 500;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2); animation: toastSlide 0.4s ease;
        display: flex; align-items: center; gap: 12px; min-width: 300px;
    }
    @keyframes toastSlide { from{transform:translateX(100%);opacity:0} to{transform:translateX(0);opacity:1} }
    .toast-success { background: linear-gradient(135deg,#43a047,#66bb6a); }
    .toast-error   { background: linear-gradient(135deg,#e53935,#ef5350); }
    .toast-info    { background: linear-gradient(135deg,#1e88e5,#42a5f5); }
    tr.editing-row { background-color: #e3f2fd !important; }

    /* ‚îÄ‚îÄ External Refs table ‚îÄ‚îÄ */
    .ext-ref-table th { font-size: 0.82rem; font-weight: 600; text-transform: uppercase; letter-spacing: .04em; }
    .badge-equipement { background: #6610f2; }
    .badge-piece      { background: #0d6efd; }

    /* ‚îÄ‚îÄ Inline edit for external refs ‚îÄ‚îÄ */
    .ext-input {
        width: 90px; padding: 4px 6px; font-size: 0.85rem;
        border: 1.5px solid #86b7fe; border-radius: 6px; text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-box-seam text-primary"></i>
                Gestion des mat√©riaux
            </h2>
            <p class="text-muted mb-0">{{ task.name }} | Projet: {{ task.project.name }}</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{{ url_for('projects.view_task', task_id=task.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Retour
            </a>
            {% if task.status != 'completed' %}
            <button type="button" class="btn btn-primary" onclick="openAddModal()">
                <i class="bi bi-plus-circle"></i> Ajouter du stock
            </button>
            <button type="button" class="btn btn-warning"
                    data-bs-toggle="modal" data-bs-target="#modalAddExtRef">
                <i class="bi bi-tools"></i> Ajouter √©quip./pi√®ce hors stock
            </button>
            {% endif %}
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Stats Cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card border-primary h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-primary bg-opacity-10 p-3 rounded flex-shrink-0">
                        <i class="bi bi-box text-primary fs-4"></i>
                    </div>
                    <div class="ms-3">
                        <h4 class="mb-0">{{ stock_items|length }}</h4>
                        <small class="text-muted">Mat√©riaux stock</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-success h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-success bg-opacity-10 p-3 rounded flex-shrink-0">
                        <i class="bi bi-check-circle text-success fs-4"></i>
                    </div>
                    <div class="ms-3">
                        <h4 class="mb-0 text-success">{{ sufficient_items|length }}</h4>
                        <small class="text-muted">Disponibles</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-warning h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-warning bg-opacity-10 p-3 rounded flex-shrink-0">
                        <i class="bi bi-exclamation-triangle text-warning fs-4"></i>
                    </div>
                    <div class="ms-3">
                        <h4 class="mb-0 text-warning">{{ shortage_items|length }}</h4>
                        <small class="text-muted">En manque</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-secondary h-100 shadow-sm">
                <div class="card-body d-flex align-items-center">
                    <div class="bg-secondary bg-opacity-10 p-3 rounded flex-shrink-0">
                        <i class="bi bi-tools text-secondary fs-4"></i>
                    </div>
                    <div class="ms-3">
                        <h4 class="mb-0 text-secondary" id="extRefCount">
                            {{ task.external_refs.count() }}
                        </h4>
                        <small class="text-muted">Hors stock</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 1 ‚Äî Mat√©riaux du stock (existant, inchang√©)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-header bg-white py-3 border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-list-check text-primary me-2"></i>
                    Mat√©riaux du stock
                </h5>
                {% if task.use_stock and task.status != 'completed' %}
                <button type="button" class="btn btn-success btn-sm" onclick="useStock()">
                    <i class="bi bi-cart-check me-1"></i>Utiliser le stock
                </button>
                {% endif %}
            </div>
        </div>

        <div class="card-body p-0 materials-table-container">
            {% if stock_items %}
            <table class="table table-hover mb-0 align-middle" id="materialsTable">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Mat√©riau</th>
                        <th class="text-center">Qt√© estim√©e</th>
                        <th class="text-center">Unit√©</th>
                        <th class="text-center">Stock dispo</th>
                        <th class="text-center">Statut</th>
                        <th class="text-center">Qt√© utilis√©e</th>
                        <th class="text-center">Reste</th>
                        <th class="text-center">√Ä ajouter</th>
                        <th class="text-center">Justif.</th>
                        <th class="text-center pe-4">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in stock_items %}
                    <tr data-item-id="{{ item.id }}"
                        data-stock-item-id="{{ item.stock_item_id }}"
                        class="{{ 'table-warning' if not item.is_quantity_sufficient() else '' }}">

                        <td class="ps-4">
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 text-primary rounded p-2 flex-shrink-0">
                                    <i class="bi bi-box"></i>
                                </div>
                                <div class="ms-3">
                                    <strong class="d-block">{{ item.stock_item.libelle if item.stock_item else 'N/A' }}</strong>
                                    <small class="text-muted">{{ item.stock_item.reference if item.stock_item else '' }}</small>
                                </div>
                            </div>
                        </td>
                        <td class="text-center"><span class="fw-bold text-muted">{{ item.estimated_quantity }}</span></td>
                        <td class="text-center"><span class="badge bg-light text-dark border">{{ item.unit_type or 'piece' }}</span></td>
                        <td class="text-center">
                            {% if item.stock_item %}
                            <span class="fw-bold {{ 'text-success' if item.stock_item.quantity >= item.estimated_quantity else 'text-danger' }}">
                                {{ item.stock_item.quantity|default(0)|round(2) }}
                            </span>
                            {% else %}<span class="text-muted">-</span>{% endif %}
                        </td>
                        <td class="text-center">
                            {% if item.is_quantity_sufficient() %}
                            <span class="badge bg-success-subtle text-success border border-success-subtle">
                                <i class="bi bi-check-circle me-1"></i>OK
                            </span>
                            {% else %}
                            <span class="badge bg-warning-subtle text-warning border border-warning-subtle">
                                <i class="bi bi-exclamation-triangle me-1"></i>Manque
                            </span>
                            {% endif %}
                        </td>

                        <!-- Qt√© utilis√©e - √âDITABLE -->
                        <td class="text-center cell-editable"
                            data-field="actual_quantity_used" data-item-id="{{ item.id }}"
                            data-value="{{ item.actual_quantity_used if item.actual_quantity_used is not none else '' }}"
                            data-original="{{ item.estimated_quantity }}"
                            {{ 'data-readonly="true"' if task.status == 'completed' else '' }}>
                            {% if task.status != 'completed' %}
                            <span class="cell-value">{{ item.actual_quantity_used if item.actual_quantity_used is not none else item.estimated_quantity }}</span>
                            <input type="number" class="cell-input" step="0.01" min="0"
                                   value="{{ item.actual_quantity_used if item.actual_quantity_used is not none else item.estimated_quantity }}">
                            <span class="cell-spinner"></span>
                            {% else %}
                            <span class="badge bg-success">{{ item.actual_quantity_used or item.estimated_quantity }}</span>
                            {% endif %}
                        </td>

                        <!-- Reste - √âDITABLE -->
                        <td class="text-center cell-editable"
                            data-field="remaining_quantity" data-item-id="{{ item.id }}"
                            data-value="{{ item.remaining_quantity if item.remaining_quantity is not none else '' }}"
                            {{ 'data-readonly="true"' if task.status == 'completed' or not item.return_to_stock else '' }}>
                            {% if task.status != 'completed' and item.return_to_stock %}
                            <span class="cell-value">{{ item.remaining_quantity or 0 }}</span>
                            <input type="number" class="cell-input" step="0.01" min="0" value="{{ item.remaining_quantity or 0 }}">
                            <span class="cell-spinner"></span>
                            {% elif not item.return_to_stock %}
                            <span class="badge bg-secondary">Non retourn√©</span>
                            {% else %}
                            <span class="text-muted">{{ item.remaining_quantity or 0 }}</span>
                            {% endif %}
                        </td>

                        <!-- √Ä ajouter - √âDITABLE -->
                        <td class="text-center cell-editable"
                            data-field="additional_quantity" data-item-id="{{ item.id }}"
                            data-value="{{ item.additional_quantity if item.additional_quantity is not none else '' }}"
                            {{ 'data-readonly="true"' if task.status == 'completed' else '' }}>
                            {% if task.status != 'completed' %}
                            <span class="cell-value {{ 'text-primary fw-bold' if item.additional_quantity else '' }}">{{ item.additional_quantity or 0 }}</span>
                            <input type="number" class="cell-input" step="0.01" min="0" value="{{ item.additional_quantity or 0 }}">
                            <span class="cell-spinner"></span>
                            {% else %}
                            <span class="text-muted">{{ item.additional_quantity or 0 }}</span>
                            {% endif %}
                        </td>

                        <!-- Justification -->
                        <td class="text-center">
                            {% if item.justification_shortage %}
                            <button type="button" class="action-btn" data-bs-toggle="tooltip"
                                    title="{{ item.justification_shortage[:100] }}...">
                                <i class="bi bi-info-circle-fill text-info"></i>
                            </button>
                            {% else %}
                            <button type="button" class="action-btn" onclick="openJustifyModal({{ item.id }})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            {% endif %}
                        </td>

                        <!-- Actions -->
                        <td class="text-center pe-4">
                            {% if task.status != 'completed' %}
                            <button type="button" class="action-btn edit-btn" onclick="openEditModal({{ item.id }})" title="√âditer">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button type="button" class="action-btn delete-btn" onclick="deleteMaterial({{ item.id }})" title="Supprimer">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="text-center py-5">
                <i class="bi bi-box-seam display-1 text-muted opacity-25"></i>
                <p class="text-muted mt-3 mb-4">Aucun mat√©riau du stock assign√© √† cette t√¢che</p>
                {% if task.status != 'completed' %}
                <button type="button" class="btn btn-primary btn-lg" onclick="openAddModal()">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter depuis le stock
                </button>
                {% endif %}
            </div>
            {% endif %}
        </div>

        {% if stock_items and task.status != 'completed' %}
        <div class="card-footer bg-light py-3">
            <small class="text-muted">
                <i class="bi bi-info-circle me-1"></i>
                <strong>Cliquez</strong> sur les valeurs des colonnes "Qt√© utilis√©e", "Reste" ou "√Ä ajouter" pour les modifier directement.
            </small>
        </div>
        {% endif %}
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
         SECTION 2 ‚Äî √âquipements & Pi√®ces HORS STOCK  (nouveau)
         ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="card shadow-sm border-0 border-top border-warning border-3">
        <div class="card-header bg-warning bg-opacity-10 py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-warning-emphasis">
                <i class="bi bi-tools me-2"></i>
                √âquipements &amp; Pi√®ces <span class="fw-normal">hors stock</span>
            </h5>
            {% if task.status != 'completed' %}
            <button class="btn btn-warning btn-sm"
                    data-bs-toggle="modal" data-bs-target="#modalAddExtRef">
                <i class="bi bi-plus-circle me-1"></i>Ajouter r√©f√©rence hors stock
            </button>
            {% endif %}
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover ext-ref-table mb-0 align-middle" id="extRefTable">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4" style="width:160px">R√©f√©rence</th>
                            <th style="width:130px">Type</th>
                            <th>Description</th>
                            <th class="text-center" style="width:110px">Qt√© utilis√©e</th>
                            <th>Notes</th>
                            <th style="width:100px">Ajout√© le</th>
                            {% if task.status != 'completed' %}
                            <th class="text-center pe-4" style="width:80px">Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="extRefBody">
                        {% set ext_refs = task.external_refs.order_by(text('created_at desc')).all() %}
                        {% if ext_refs %}
                            {% for r in ext_refs %}
                            <tr id="ext-ref-row-{{ r.id }}">
                                <td class="ps-4">
                                    <span class="fw-semibold font-monospace">{{ r.reference }}</span>
                                </td>
                                <td>
                                    {% if r.item_type == 'equipement' %}
                                    <span class="badge badge-equipement text-white">
                                        <i class="bi bi-cpu me-1"></i>√âquipement
                                    </span>
                                    {% else %}
                                    <span class="badge badge-piece text-white">
                                        <i class="bi bi-gear me-1"></i>Pi√®ce
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="text-muted">{{ r.description or '‚Äî' }}</td>
                                <!-- Qt√© utilis√©e inline edit -->
                                <td class="text-center">
                                    {% if task.status != 'completed' %}
                                    <input type="number" class="ext-input ext-used"
                                           data-ref-id="{{ r.id }}" data-field="quantity_used"
                                           value="{{ r.quantity_used if r.quantity_used is not none else '' }}"
                                           placeholder="‚Äî" step="0.01" min="0">
                                    {% else %}
                                    {{ r.quantity_used if r.quantity_used is not none else '‚Äî' }}
                                    {% endif %}
                                </td>

                                <td class="text-muted small">{{ r.notes or '‚Äî' }}</td>
                                <td class="text-muted small">{{ r.created_at.strftime('%d/%m/%Y') if r.created_at }}</td>

                                {% if task.status != 'completed' %}
                                <td class="text-center pe-4">
                                    <button class="action-btn delete-btn btn-delete-ext-ref"
                                            data-ref-id="{{ r.id }}" data-ref-label="{{ r.reference }}"
                                            title="Supprimer">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr id="ext-ref-empty">
                            <td colspan="7" class="text-center text-muted py-4">
                                <i class="bi bi-tools opacity-25 fs-2 d-block mb-2"></i>
                                Aucun √©quipement ou pi√®ce hors stock pour cette t√¢che.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div><!-- /container -->

<!-- ‚îÄ‚îÄ Toast Container ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="toast-container" id="toastContainer"></div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODALS ‚Äî Stock (existants, inchang√©s)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Modal: √âdition compl√®te mat√©riau stock -->
<div class="modal fade" id="editMaterialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>√âditer le mat√©riau</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="editMaterialForm" onsubmit="submitEditModal(event)">
                <input type="hidden" id="editItemId" name="item_id">
                <div class="modal-body">
                    <div class="row g-4">
                        <div class="col-12">
                            <div class="p-3 bg-light rounded border">
                                <div class="d-flex align-items-center">
                                    <span class="bg-primary bg-opacity-10 text-primary rounded p-2 flex-shrink-0">
                                        <i class="bi bi-box fs-4"></i>
                                    </span>
                                    <div class="ms-3">
                                        <h6 class="mb-1" id="editMaterialName">-</h6>
                                        <small class="text-muted" id="editMaterialRef">-</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted">Quantit√© estim√©e</label>
                            <input type="text" class="form-control" id="editEstimatedQty" readonly disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold text-muted">Unit√©</label>
                            <input type="text" class="form-control" id="editUnit" readonly disabled>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-success"><i class="bi bi-check-circle me-1"></i>Qt√© utilis√©e</label>
                            <input type="number" name="actual_quantity_used" id="editActualQty" class="form-control form-control-lg" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-info"><i class="bi bi-arrow-return-left me-1"></i>Reste</label>
                            <input type="number" name="remaining_quantity" id="editRemainingQty" class="form-control form-control-lg" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold text-primary"><i class="bi bi-plus-circle me-1"></i>√Ä ajouter</label>
                            <input type="number" name="additional_quantity" id="editAdditionalQty" class="form-control form-control-lg" step="0.01" min="0">
                        </div>
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="return_to_stock" id="editReturnToStock" value="1">
                                <label class="form-check-label fw-bold" for="editReturnToStock">Retourner le reste au stock</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold text-warning"><i class="bi bi-chat-left-text me-1"></i>Justification</label>
                            <textarea name="justification_shortage" id="editJustification" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold text-muted"><i class="bi bi-sticky me-1"></i>Notes</label>
                            <textarea name="notes" id="editNotes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-1"></i>Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Ajouter depuis stock -->
<div class="modal fade" id="addMaterialModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle me-2"></i>Ajouter des mat√©riaux</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="searchStock" placeholder="Rechercher..." onkeyup="filterStock()">
                    </div>
                </div>
                <div class="table-responsive" style="max-height:400px">
                    <table class="table table-sm table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="40"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                                <th>Mat√©riau</th>
                                <th class="text-center">Stock</th>
                                <th width="100">Qt√©</th>
                            </tr>
                        </thead>
                        <tbody id="stockList">
                            {% for stock in all_stock_items %}
                            <tr class="stock-item" data-name="{{ stock.libelle|lower }} {{ stock.reference|lower }}">
                                <td><input type="checkbox" class="stock-check form-check-input" value="{{ stock.id }}"></td>
                                <td>
                                    <strong>{{ stock.libelle }}</strong>
                                    <br><small class="text-muted">{{ stock.reference }}</small>
                                </td>
                                <td class="text-center">
                                    <span class="badge {{ 'bg-success' if stock.quantity > 20 else 'bg-warning' if stock.quantity > 0 else 'bg-danger' }}">
                                        {{ stock.quantity|round(2) }}
                                    </span>
                                </td>
                                <td>
                                    <input type="number" class="form-control form-control-sm stock-qty"
                                           data-id="{{ stock.id }}" value="1" min="0.01" step="0.01">
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" onclick="submitAddMaterials()">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Justifier -->
<div class="modal fade" id="justifyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Justifier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="justifyForm" onsubmit="submitJustify(event)">
                <input type="hidden" id="justifyItemId" name="item_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Quantit√© manquante *</label>
                        <input type="number" name="additional_quantity_needed" class="form-control" step="0.01" min="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Justification *</label>
                        <textarea name="justification" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">Valider</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODAL ‚Äî Ajouter √©quipement/pi√®ce hors stock  (NOUVEAU)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal fade" id="modalAddExtRef" tabindex="-1"
     aria-labelledby="modalAddExtRefLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning bg-opacity-10">
                <h5 class="modal-title text-warning-emphasis" id="modalAddExtRefLabel">
                    <i class="bi bi-tools me-2"></i>
                    Ajouter √©quipement(s) / pi√®ce(s) hors stock
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <p class="text-muted small mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    Ces articles <strong>n'existent pas dans votre stock</strong>.
                    Seule la r√©f√©rence est obligatoire. Vous pouvez renseigner les quantit√©s
                    utilis√©es / retourn√©es directement dans le tableau une fois ajout√©s.
                </p>

                <div id="extRefRows">
                    <!-- Ligne template (dupliqu√©e par JS) -->
                    <div class="ext-ref-row border rounded p-3 mb-2 bg-light position-relative" data-row="1">
                        <button type="button"
                                class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-1 btn-remove-row"
                                style="display:none" title="Supprimer">
                            <i class="bi bi-x-lg"></i>
                        </button>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label fw-semibold mb-1">
                                    R√©f√©rence <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control ext-ref-reference"
                                       placeholder="ex: EQ-001 ou PIECE-XYZ" maxlength="128">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-semibold mb-1">Type <span class="text-danger">*</span></label>
                                <select class="form-select ext-ref-type">
                                    <option value="piece" selected>üî© Pi√®ce d√©tach√©e</option>
                                    <option value="equipement">üñ•Ô∏è √âquipement</option>
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label fw-semibold mb-1">Description</label>
                                <input type="text" class="form-control ext-ref-description"
                                       placeholder="Libell√© court" maxlength="255">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-semibold mb-1">Notes</label>
                                <input type="text" class="form-control ext-ref-notes"
                                       placeholder="Remarques, urgence‚Ä¶ (optionnel)" maxlength="500">
                            </div>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn btn-outline-secondary btn-sm mt-1" id="btnAddExtRefRow">
                    <i class="bi bi-plus me-1"></i>Ajouter une autre ligne
                </button>
            </div>

            <div class="modal-footer">
                <div id="extRefModalAlert" class="me-auto small"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-warning" id="btnSaveExtRefs">
                    <span class="spinner-border spinner-border-sm me-1 d-none" id="spinnerExtRef"></span>
                    <i class="bi bi-check-lg me-1"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
/* ============================================================
   CONFIG
   ============================================================ */
const CFG = {
    csrf: '{{ csrf_token() }}',
    taskId: {{ task.id }},
    ep: {
        update_field:  '{{ url_for("projects.update_material_field") }}',
        update_full:   '{{ url_for("projects.update_material_full") }}',
        get_material:  '{{ url_for("projects.get_material", item_id=0) }}'.replace('/0', '/'),
        add_batch:     '{{ url_for("projects.add_stock_items_batch", task_id=task.id) }}',
        use_stock:     '{{ url_for("projects.use_stock", task_id=task.id) }}',
        delete_stock:  '/projects/tasks/materials/',
        justify:       '/projects/tasks/materials/',
        ext_add:       '/projects/tasks/{{ task.id }}/external-refs/add',
        ext_delete:    (id) => `/projects/tasks/{{ task.id }}/external-refs/${id}/delete`,
        ext_update:    (id) => `/projects/tasks/{{ task.id }}/external-refs/${id}/update`,
    }
};

/* ============================================================
   TOAST
   ============================================================ */
function showToast(msg, type = 'info') {
    const c = document.getElementById('toastContainer');
    const el = document.createElement('div');
    el.className = `toast-custom toast-${type}`;
    const icons = { success:'check-circle-fill', error:'x-circle-fill', info:'info-circle-fill' };
    el.innerHTML = `<i class="bi bi-${icons[type]||icons.info}"></i><span>${esc(msg)}</span>`;
    c.appendChild(el);
    setTimeout(() => { el.style.opacity='0'; el.style.transform='translateX(100%)'; setTimeout(()=>el.remove(),300); }, 3000);
}

function esc(s){ if(!s)return''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

/* ============================================================
   INLINE EDITING ‚Äî Stock table (original logic, untouched)
   ============================================================ */
const MaterialsManager = (function(){
    'use strict';
    let activeEdit = null;

    function init(){
        bindEditableCells();
        bindGlobalEvents();
        document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => new bootstrap.Tooltip(el));
    }

    function bindEditableCells(){
        document.querySelectorAll('.cell-editable:not([data-readonly="true"])').forEach(cell => {
            const value = cell.querySelector('.cell-value');
            const input = cell.querySelector('.cell-input');
            if (!value||!input) return;
            value.addEventListener('click', e => { e.stopPropagation(); startEdit(cell, input); });
            input.addEventListener('keydown', handleInputKeydown);
            input.addEventListener('blur', () => finishEdit(cell));
        });
    }

    function startEdit(cell, input){
        if (activeEdit && activeEdit!==cell) finishEdit(activeEdit);
        cell.closest('tr')?.classList.add('editing-row');
        activeEdit = cell;
        cell.classList.add('editing');
        const v = cell.dataset.value;
        input.value = v!=='' ? v : (cell.dataset.original||'0');
        input.focus(); input.select();
    }

    function handleInputKeydown(e){
        const cell = e.target.closest('.cell-editable');
        if (e.key==='Enter')  { e.preventDefault(); finishEdit(cell); }
        if (e.key==='Escape') { e.preventDefault(); cancelEdit(cell); }
        if (e.key==='Tab')    { e.preventDefault(); finishEdit(cell); moveToNext(cell, e.shiftKey); }
    }

    function moveToNext(cur, rev){
        const cells = [...document.querySelectorAll('.cell-editable:not([data-readonly="true"])')];
        const i = cells.indexOf(cur) + (rev?-1:1);
        if (i>=0&&i<cells.length){ const inp=cells[i].querySelector('.cell-input'); if(inp){ cells[i].scrollIntoView({behavior:'smooth',block:'center'}); startEdit(cells[i],inp); } }
    }

    function finishEdit(cell){
        if (!cell.classList.contains('editing')) return;
        const input = cell.querySelector('.cell-input');
        const nv = input.value.trim();
        if (!nv){ cancelEdit(cell); return; }
        const num = parseFloat(nv);
        if (isNaN(num)||num<0){ showToast('Valeur invalide','error'); cancelEdit(cell); return; }
        if (num===parseFloat(cell.dataset.value)){ cancelEdit(cell); return; }
        saveInline(cell, num);
    }

    function cancelEdit(cell){
        cell.closest('tr')?.classList.remove('editing-row');
        cell.classList.remove('editing');
        activeEdit = null;
    }

    async function saveInline(cell, value){
        cell.classList.remove('editing'); cell.classList.add('saving');
        try {
            const res = await fetch(CFG.ep.update_field, {
                method:'POST',
                headers:{'Content-Type':'application/json','X-CSRFToken':CFG.csrf},
                body: JSON.stringify({item_id:parseInt(cell.dataset.itemId), field:cell.dataset.field, value})
            });
            const d = await res.json();
            if (!d.success) throw new Error(d.error||'Erreur serveur');
            cell.dataset.value = value;
            const ve = cell.querySelector('.cell-value');
            if (ve) ve.textContent = value;
            if (d.auto_calculated && cell.dataset.field==='actual_quantity_used'){
                const rc = cell.closest('tr').querySelector('[data-field="remaining_quantity"]');
                if (rc){ rc.dataset.value=d.remaining_quantity; const re=rc.querySelector('.cell-value'); if(re) re.textContent=d.remaining_quantity; }
            }
            cell.classList.remove('saving'); cell.classList.add('saved');
            showToast(`Mis √† jour : ${value}`, 'success');
            setTimeout(()=>{ cell.classList.remove('saved'); cell.closest('tr')?.classList.remove('editing-row'); }, 1000);
        } catch(err){
            cell.classList.remove('saving'); cell.classList.add('error');
            const ve=cell.querySelector('.cell-value'); if(ve) ve.textContent=cell.dataset.value||'0';
            showToast('Erreur: '+err.message,'error');
            setTimeout(()=>{ cell.classList.remove('error'); cell.closest('tr')?.classList.remove('editing-row'); },2000);
        } finally { activeEdit=null; }
    }

    function bindGlobalEvents(){
        document.addEventListener('click', e => { if (activeEdit&&!e.target.closest('.cell-editable')) finishEdit(activeEdit); });
        document.getElementById('selectAll')?.addEventListener('change', e => {
            document.querySelectorAll('.stock-check').forEach(cb => cb.checked=e.target.checked);
        });
    }

    return { init };
})();

document.addEventListener('DOMContentLoaded', MaterialsManager.init);


/* ============================================================
   STOCK MODAL FUNCTIONS (original, untouched)
   ============================================================ */
async function openEditModal(itemId){
    try {
        const d = await (await fetch(`${CFG.ep.get_material}${itemId}`)).json();
        if (!d.success) throw new Error(d.error);
        const it=d.item, si=d.stock_item;
        document.getElementById('editItemId').value = itemId;
        document.getElementById('editMaterialName').textContent = si?.libelle||'N/A';
        document.getElementById('editMaterialRef').textContent  = si?.reference||'';
        document.getElementById('editEstimatedQty').value = it.estimated_quantity;
        document.getElementById('editUnit').value         = it.unit_type;
        document.getElementById('editActualQty').value    = it.actual_quantity_used??it.estimated_quantity;
        document.getElementById('editRemainingQty').value = it.remaining_quantity||0;
        document.getElementById('editAdditionalQty').value= it.additional_quantity||0;
        document.getElementById('editReturnToStock').checked = it.return_to_stock;
        document.getElementById('editJustification').value = it.justification_shortage||'';
        document.getElementById('editNotes').value         = it.notes||'';
        new bootstrap.Modal(document.getElementById('editMaterialModal')).show();
    } catch(e){ showToast('Erreur: '+e.message,'error'); }
}

async function submitEditModal(ev){
    ev.preventDefault();
    const f=ev.target, id=document.getElementById('editItemId').value;
    try {
        const res = await fetch(CFG.ep.update_full,{
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':CFG.csrf},
            body:JSON.stringify({
                item_id:parseInt(id),
                actual_quantity_used:parseFloat(f.actual_quantity_used.value)||0,
                remaining_quantity:parseFloat(f.remaining_quantity.value)||0,
                additional_quantity:parseFloat(f.additional_quantity.value)||0,
                return_to_stock:f.return_to_stock.checked?1:0,
                justification_shortage:f.justification_shortage.value||'',
                notes:f.notes.value||''
            })
        });
        const r=await res.json();
        if (!r.success) throw new Error(r.error);
        showToast('Enregistr√© !','success');
        bootstrap.Modal.getInstance(document.getElementById('editMaterialModal')).hide();
        setTimeout(()=>location.reload(),500);
    } catch(e){ showToast('Erreur: '+e.message,'error'); }
}

function openAddModal(){ new bootstrap.Modal(document.getElementById('addMaterialModal')).show(); }
function filterStock(){
    const s=document.getElementById('searchStock').value.toLowerCase();
    document.querySelectorAll('.stock-item').forEach(r=>{ r.style.display=r.dataset.name.includes(s)?'':'none'; });
}

async function submitAddMaterials(){
    const sel=[];
    document.querySelectorAll('.stock-check:checked').forEach(cb=>{
        const q=document.querySelector(`.stock-qty[data-id="${cb.value}"]`);
        const qty=q?parseFloat(q.value):1;
        if (qty>0) sel.push({stock_item_id:cb.value,estimated_quantity:qty,unit_type:'piece'});
    });
    if (!sel.length){ showToast('S√©lectionnez au moins un mat√©riau','error'); return; }
    try {
        const d=await (await fetch(CFG.ep.add_batch,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':CFG.csrf},body:JSON.stringify({items:sel})})).json();
        if (!d.success) throw new Error(d.error);
        showToast('Mat√©riaux ajout√©s !','success');
        setTimeout(()=>location.reload(),1000);
    } catch(e){ showToast('Erreur: '+e.message,'error'); }
}

function openJustifyModal(id){ document.getElementById('justifyItemId').value=id; new bootstrap.Modal(document.getElementById('justifyModal')).show(); }

async function submitJustify(ev){
    ev.preventDefault();
    const id=document.getElementById('justifyItemId').value;
    try {
        const res=await fetch(`${CFG.ep.justify}${id}/justify-shortage`,{method:'POST',body:new FormData(ev.target)});
        if (!res.ok) throw new Error('Erreur serveur');
        showToast('Justificatif enregistr√©','success');
        bootstrap.Modal.getInstance(document.getElementById('justifyModal')).hide();
        setTimeout(()=>location.reload(),1000);
    } catch(e){ showToast('Erreur: '+e.message,'error'); }
}

async function useStock(){
    if (!confirm('Confirmer l\'utilisation du stock ?\n\nCette action d√©duira les quantit√©s du stock disponible.')) return;
    try {
        const d=await (await fetch(CFG.ep.use_stock,{method:'POST',headers:{'Content-Type':'application/json','X-CSRFToken':CFG.csrf}})).json();
        if (d.success){ showToast('Stock utilis√© !','success'); setTimeout(()=>location.reload(),1500); }
        else if (d.insufficient_items){ let m='Stock insuffisant pour:\n'; d.insufficient_items.forEach(i=>m+=`‚Ä¢ ${i.name}: besoin ${i.needed}, dispo ${i.available}\n`); alert(m); }
        else throw new Error(d.error);
    } catch(e){ showToast('Erreur: '+e.message,'error'); }
}

async function deleteMaterial(itemId){
    if (!confirm('Supprimer ce mat√©riau ?')) return;
    try {
        const res=await fetch(`${CFG.ep.delete_stock}${itemId}/delete`,{method:'POST',headers:{'X-CSRFToken':CFG.csrf}});
        if (!res.ok) throw new Error('Erreur');
        showToast('Mat√©riau supprim√©','success');
        document.querySelector(`tr[data-item-id="${itemId}"]`)?.remove();
    } catch(e){ showToast('Erreur: '+e.message,'error'); }
}


/* ============================================================
   EXTERNAL REFS ‚Äî Add modal (multi-row)
   ============================================================ */
let extRowCount = 1;

function buildExtRow(){
    extRowCount++;
    const d = document.createElement('div');
    d.className = 'ext-ref-row border rounded p-3 mb-2 bg-light position-relative';
    d.dataset.row = extRowCount;
    d.innerHTML = `
      <button type="button" class="btn btn-sm btn-outline-danger position-absolute top-0 end-0 m-1 btn-remove-row" title="Supprimer">
        <i class="bi bi-x-lg"></i>
      </button>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label fw-semibold mb-1">R√©f√©rence <span class="text-danger">*</span></label>
          <input type="text" class="form-control ext-ref-reference" placeholder="ex: EQ-001" maxlength="128">
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold mb-1">Type <span class="text-danger">*</span></label>
          <select class="form-select ext-ref-type">
            <option value="piece" selected>üî© Pi√®ce d√©tach√©e</option>
            <option value="equipement">üñ•Ô∏è √âquipement</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label fw-semibold mb-1">Description</label>
          <input type="text" class="form-control ext-ref-description" placeholder="Libell√© court" maxlength="255">
        </div>
        <div class="col-12">
          <label class="form-label fw-semibold mb-1">Notes</label>
          <input type="text" class="form-control ext-ref-notes" placeholder="Optionnel" maxlength="500">
        </div>
      </div>`;
    return d;
}

function syncRemoveButtons(){
    const rows = document.querySelectorAll('.ext-ref-row');
    rows.forEach(r => { const b=r.querySelector('.btn-remove-row'); if(b) b.style.display = rows.length>1?'':'none'; });
}

document.getElementById('btnAddExtRefRow')?.addEventListener('click', () => {
    const row = buildExtRow();
    document.getElementById('extRefRows').appendChild(row);
    syncRemoveButtons();
    row.querySelector('.ext-ref-reference').focus();
});

document.getElementById('extRefRows')?.addEventListener('click', e => {
    const btn = e.target.closest('.btn-remove-row');
    if (!btn) return;
    btn.closest('.ext-ref-row').remove();
    syncRemoveButtons();
});

document.getElementById('btnSaveExtRefs')?.addEventListener('click', async () => {
    const alertEl  = document.getElementById('extRefModalAlert');
    const spinner  = document.getElementById('spinnerExtRef');
    const saveBtn  = document.getElementById('btnSaveExtRefs');
    alertEl.innerHTML = '';

    const refs = [];
    let hasErr = false;
    document.querySelectorAll('.ext-ref-row').forEach(row => {
        const ref = row.querySelector('.ext-ref-reference').value.trim();
        if (!ref){ row.querySelector('.ext-ref-reference').classList.add('is-invalid'); hasErr=true; return; }
        row.querySelector('.ext-ref-reference').classList.remove('is-invalid');
        refs.push({
            reference:   ref,
            item_type:   row.querySelector('.ext-ref-type').value,
            description: row.querySelector('.ext-ref-description').value.trim(),
            notes:       row.querySelector('.ext-ref-notes').value.trim(),
        });
    });

    if (hasErr){ alertEl.innerHTML='<span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Remplissez toutes les r√©f√©rences obligatoires.</span>'; return; }
    if (!refs.length){ alertEl.innerHTML='<span class="text-danger">Aucune r√©f√©rence saisie.</span>'; return; }

    spinner.classList.remove('d-none'); saveBtn.disabled=true;

    try {
        const d = await (await fetch(CFG.ep.ext_add, {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':CFG.csrf},
            body: JSON.stringify({refs})
        })).json();

        if (!d.success) throw new Error(d.error);

        bootstrap.Modal.getInstance(document.getElementById('modalAddExtRef')).hide();
        resetExtModal();
        renderExtRefs(d.refs);
        document.getElementById('extRefCount').textContent = d.refs.length;
        showToast(d.message, 'success');

    } catch(err){
        alertEl.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>${esc(err.message)}</span>`;
    } finally {
        spinner.classList.add('d-none'); saveBtn.disabled=false;
    }
});

function resetExtModal(){
    const c = document.getElementById('extRefRows');
    [...c.querySelectorAll('.ext-ref-row')].slice(1).forEach(r=>r.remove());
    c.querySelectorAll('input[type="text"]').forEach(i => i.value = '');
    c.querySelectorAll('select').forEach(s=>s.selectedIndex=0);
    c.querySelectorAll('.is-invalid').forEach(el=>el.classList.remove('is-invalid'));
    document.getElementById('extRefModalAlert').innerHTML='';
    syncRemoveButtons();
}

/* ‚îÄ‚îÄ Render external refs table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
function renderExtRefs(refs){
    const tbody = document.getElementById('extRefBody');
    tbody.innerHTML = '';

    if (!refs.length){
        tbody.innerHTML=`<tr id="ext-ref-empty"><td colspan="9" class="text-center text-muted py-4"><i class="bi bi-tools opacity-25 fs-2 d-block mb-2"></i>Aucun √©quipement ou pi√®ce hors stock pour cette t√¢che.</td></tr>`;
        return;
    }

    refs.forEach(r => {
        const badge = r.item_type==='equipement'
            ? `<span class="badge badge-equipement text-white"><i class="bi bi-cpu me-1"></i>√âquipement</span>`
            : `<span class="badge badge-piece text-white"><i class="bi bi-gear me-1"></i>Pi√®ce</span>`;

        tbody.insertAdjacentHTML('beforeend', `
          <tr id="ext-ref-row-${r.id}">
            <td class="ps-4"><span class="fw-semibold font-monospace">${esc(r.reference)}</span></td>
            <td>${badge}</td>
            <td class="text-muted">${esc(r.description)||'‚Äî'}</td>
            <td class="text-center">
              <input type="number" class="ext-input ext-used" data-ref-id="${r.id}" data-field="quantity_used"
                     value="${r.quantity_used??''}" placeholder="‚Äî" step="0.01" min="0">
            </td>
            <td class="text-muted small">${esc(r.notes)||'‚Äî'}</td>
            <td class="text-muted small">${r.created_at}</td>
            <td class="text-center pe-4">
              <button class="action-btn delete-btn btn-delete-ext-ref" data-ref-id="${r.id}" data-ref-label="${esc(r.reference)}" title="Supprimer">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>`);
    });
}

/* ‚îÄ‚îÄ Inline save for quantity_used ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('extRefBody')?.addEventListener('change', async e => {
    const inp = e.target.closest('.ext-input');
    if (!inp) return;
    const refId = inp.dataset.refId;
    const field  = inp.dataset.field;
    const value  = inp.value.trim()==='' ? null : parseFloat(inp.value);

    try {
        const d = await (await fetch(CFG.ep.ext_update(refId), {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':CFG.csrf},
            body: JSON.stringify({[field]: value})
        })).json();
        if (!d.success) throw new Error(d.error);
        inp.classList.remove('is-invalid');
        inp.style.borderColor = '#86efac';
        setTimeout(()=>inp.style.borderColor='', 1500);
        showToast('Mis √† jour','success');
    } catch(err){
        inp.classList.add('is-invalid');
        showToast('Erreur: '+err.message,'error');
    }
});

/* ‚îÄ‚îÄ Delete external ref ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
document.getElementById('extRefBody')?.addEventListener('click', async e => {
    const btn = e.target.closest('.btn-delete-ext-ref');
    if (!btn) return;
    const {refId, refLabel} = btn.dataset;
    if (!confirm(`Supprimer "${refLabel}" ?`)) return;
    btn.disabled = true;
    try {
        const d = await (await fetch(CFG.ep.ext_delete(refId), {
            method:'POST', headers:{'X-CSRFToken':CFG.csrf}
        })).json();
        if (!d.success) throw new Error(d.error);
        document.getElementById(`ext-ref-row-${refId}`)?.remove();
        const remaining = document.querySelectorAll('#extRefBody tr[id^="ext-ref-row-"]').length;
        document.getElementById('extRefCount').textContent = remaining;
        if (!remaining){
            document.getElementById('extRefBody').innerHTML=`<tr id="ext-ref-empty"><td colspan="9" class="text-center text-muted py-4"><i class="bi bi-tools opacity-25 fs-2 d-block mb-2"></i>Aucun √©quipement ou pi√®ce hors stock pour cette t√¢che.</td></tr>`;
        }
        showToast(d.message,'success');
    } catch(err){ showToast('Erreur: '+err.message,'error'); btn.disabled=false; }
});
</script>
{% endblock %}